generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Account {
  A_ID                                             String        @id @db.VarChar(10)
  UserName                                         String        @unique(map: "UserName") @db.VarChar(80)
  PassWord                                         String        @db.VarChar(255)
  Email                                            String        @unique(map: "Email") @db.VarChar(150)
  R_ID                                             String        @db.VarChar(10)
  M_ID                                             String?       @db.VarChar(10)
  Status                                           String?       @db.VarChar(30)
  Deleted_At                                       DateTime?     @db.DateTime(0)
  Deleted_By                                       String?       @db.VarChar(10)
  IsDeleted                                        Boolean       @default(false)
  Last_Active                                      DateTime?     @db.DateTime(0)
  Avatar                                           String?       @db.VarChar(255)
  ResetToken                                       String?       @db.VarChar(255)
  ResetTokenExpires                                DateTime?     @db.DateTime(0)
  FailedLoginAttempts                              Int           @default(0)
  LockedUntil                                      DateTime?     @db.DateTime(0)
  LastPasswordChange                               DateTime?     @db.DateTime(0)
  Member                                           Member?       @relation(fields: [M_ID], references: [M_ID], onDelete: NoAction, onUpdate: NoAction, map: "FK_Account_Member")
  Role                                             Role          @relation(fields: [R_ID], references: [R_ID], onDelete: NoAction, onUpdate: NoAction, map: "FK_Account_Role")
  Project                                          Project[]
  Task                                             Task[]
  Task_Report_Task_Report_Created_By_A_IDToAccount Task_Report[] @relation("Task_Report_Created_By_A_IDToAccount")
  Task_Report_Task_Report_Reporter_A_IDToAccount   Task_Report[] @relation("Task_Report_Reporter_A_IDToAccount")
  TaskComments                                     TaskComment[]
  NotificationsReceived                            Notification[] @relation("NotificationRecipient")
  NotificationsSent                                Notification[] @relation("NotificationSender")
  SystemLogs                                       SystemLog[]

  @@index([M_ID], map: "FK_Account_Member")
  @@index([R_ID], map: "FK_Account_Role")
}

// Notification model for system notifications
model Notification {
  N_ID        String    @id @db.VarChar(20)
  Type        String    @db.VarChar(50)  // task_assigned, task_approved, deadline_changed, overdue, comment, file_attached
  Message     String    @db.VarChar(500)
  IsRead      Boolean   @default(false)
  CreatedAt   DateTime  @default(now()) @db.DateTime(0)
  
  // Recipient (required)
  RecipientId String    @db.VarChar(10)
  Recipient   Account   @relation("NotificationRecipient", fields: [RecipientId], references: [A_ID], onDelete: NoAction, onUpdate: NoAction, map: "FK_Notification_Recipient")
  
  // Sender (optional - system notifications have no sender)
  SenderId    String?   @db.VarChar(10)
  Sender      Account?  @relation("NotificationSender", fields: [SenderId], references: [A_ID], onDelete: NoAction, onUpdate: NoAction, map: "FK_Notification_Sender")
  
  // Related entities (optional)
  TaskId      String?   @db.VarChar(10)
  Task        Task?     @relation(fields: [TaskId], references: [T_ID], onDelete: NoAction, onUpdate: NoAction, map: "FK_Notification_Task")
  ProjectId   String?   @db.VarChar(10)
  Project     Project?  @relation(fields: [ProjectId], references: [P_ID], onDelete: NoAction, onUpdate: NoAction, map: "FK_Notification_Project")

  @@index([RecipientId], map: "FK_Notification_Recipient")
  @@index([SenderId], map: "FK_Notification_Sender")
  @@index([TaskId], map: "FK_Notification_Task")
  @@index([ProjectId], map: "FK_Notification_Project")
  @@index([CreatedAt])
}

model Department {
  D_ID             String       @id @db.VarChar(10)
  D_Name           String       @db.VarChar(200)
  Parent_D_ID      String?      @db.VarChar(10)
  Status           String?      @db.VarChar(30)
  Deleted_At       DateTime?    @db.DateTime(0)
  Deleted_By       String?      @db.VarChar(10)
  IsDeleted        Boolean      @default(false)
  Department       Department?  @relation("DepartmentToDepartment", fields: [Parent_D_ID], references: [D_ID], onDelete: NoAction, onUpdate: NoAction, map: "FK_Department_Parent")
  other_Department Department[] @relation("DepartmentToDepartment")
  Member           Member[]
  Project          Project[]

  @@index([Parent_D_ID], map: "FK_Department_Parent")
}

model Member {
  M_ID        String        @id @db.VarChar(10)
  FullName    String        @db.VarChar(200)
  PhoneNumber String?       @db.VarChar(30)
  BirthDate   DateTime?     @db.Date
  JoinDate    DateTime?     @db.Date
  D_ID        String        @db.VarChar(10)
  Status      String?       @db.VarChar(30)
  Deleted_At  DateTime?     @db.DateTime(0)
  Deleted_By  String?       @db.VarChar(10)
  IsDeleted   Boolean       @default(false)
  Account     Account[]
  Department  Department    @relation(fields: [D_ID], references: [D_ID], onDelete: NoAction, onUpdate: NoAction, map: "FK_Member_Department")
  Task        Task[]
  Task_Member Task_Member[]

  @@index([D_ID], map: "FK_Member_Department")
}

model Permission {
  P_ID            String            @id @db.VarChar(10)
  P_Name          String            @unique(map: "P_Name") @db.VarChar(150)
  Description     String?           @db.VarChar(400)
  Role_Permission Role_Permission[]
}

model Project {
  P_ID            String     @id @db.VarChar(10)
  D_ID            String     @db.VarChar(10)
  P_Name          String     @db.VarChar(200)
  P_Description   String?    @db.VarChar(500)
  Begin_Date      DateTime?  @db.Date
  End_Date        DateTime?  @db.Date
  Created_By_A_ID String?    @db.VarChar(10)
  Status          String?    @db.VarChar(30)
  Deleted_At      DateTime?  @db.DateTime(0)
  Deleted_By      String?    @db.VarChar(10)
  IsDeleted       Boolean    @default(false)
  Account         Account?   @relation(fields: [Created_By_A_ID], references: [A_ID], onDelete: NoAction, onUpdate: NoAction, map: "FK_Project_CreatedBy")
  Department      Department @relation(fields: [D_ID], references: [D_ID], onDelete: NoAction, onUpdate: NoAction, map: "FK_Project_Department")
  Task            Task[]
  Notifications   Notification[]

  @@index([Created_By_A_ID], map: "FK_Project_CreatedBy")
  @@index([D_ID], map: "FK_Project_Department")
}

model Role {
  R_ID            String            @id @db.VarChar(10)
  R_Name          String            @unique(map: "R_Name") @db.VarChar(100)
  Description     String?           @db.VarChar(400)
  Account         Account[]
  Role_Permission Role_Permission[]
}

model Role_Permission {
  R_ID       String     @db.VarChar(10)
  P_ID       String     @db.VarChar(10)
  Permission Permission @relation(fields: [P_ID], references: [P_ID], onDelete: NoAction, onUpdate: NoAction, map: "FK_RP_Permission")
  Role       Role       @relation(fields: [R_ID], references: [R_ID], onDelete: NoAction, onUpdate: NoAction, map: "FK_RP_Role")

  @@id([R_ID, P_ID])
  @@index([P_ID], map: "FK_RP_Permission")
}

model Task {
  T_ID             String        @id @db.VarChar(10)
  Title            String        @db.VarChar(200)
  Description      String?       @db.Text
  Begin_Date       DateTime?     @db.Date
  Due_Date         DateTime?     @db.Date
  Priority         String?       @db.VarChar(30)
  Complete_At      DateTime?     @db.DateTime(0)
  P_ID             String        @db.VarChar(10)
  Assigned_ID_M_ID String?       @db.VarChar(10)
  Created_By_A_ID  String?       @db.VarChar(10)
  Parent_T_ID      String?       @db.VarChar(10)
  Status           String?       @db.VarChar(30)
  Deleted_At       DateTime?     @db.DateTime(0)
  Deleted_By       String?       @db.VarChar(10)
  Progress         Int           @default(0)
  IsDeleted        Boolean       @default(false)
  Member           Member?       @relation(fields: [Assigned_ID_M_ID], references: [M_ID], onDelete: NoAction, onUpdate: NoAction, map: "FK_Task_AssignedMember")
  Account          Account?      @relation(fields: [Created_By_A_ID], references: [A_ID], onDelete: NoAction, onUpdate: NoAction, map: "FK_Task_CreatedBy")
  ParentTask       Task?         @relation("TaskSubtasks", fields: [Parent_T_ID], references: [T_ID], onDelete: NoAction, onUpdate: NoAction, map: "FK_Task_ParentTask")
  Subtasks         Task[]        @relation("TaskSubtasks")
  Project          Project       @relation(fields: [P_ID], references: [P_ID], onDelete: NoAction, onUpdate: NoAction, map: "FK_Task_Project")
  Task_Member      Task_Member[]
  Task_Report      Task_Report[]
  ChecklistItems   ChecklistItem[]
  Attachments      Attachment[]
  Task_Labels      Task_Label[]
  TaskComments     TaskComment[]
  Notifications    Notification[]

  @@index([Assigned_ID_M_ID], map: "FK_Task_AssignedMember")
  @@index([Created_By_A_ID], map: "FK_Task_CreatedBy")
  @@index([P_ID], map: "FK_Task_Project")
  @@index([Parent_T_ID], map: "FK_Task_ParentTask")
}

model Label {
  L_ID        String       @id @default(uuid()) @db.VarChar(36)
  Name        String       @db.VarChar(100)
  Color       String       @db.VarChar(20)
  Task_Labels Task_Label[]
}

model Task_Label {
  T_ID  String @db.VarChar(10)
  L_ID  String @db.VarChar(36)
  Task  Task   @relation(fields: [T_ID], references: [T_ID], onDelete: Cascade)
  Label Label  @relation(fields: [L_ID], references: [L_ID], onDelete: Cascade)

  @@id([T_ID, L_ID])
  @@index([L_ID], map: "FK_TL_Label")
  @@index([T_ID], map: "FK_TL_Task")
}

model ChecklistItem {
  CL_ID       String   @id @default(uuid()) @db.VarChar(36)
  Content     String   @db.VarChar(255)
  IsCompleted Boolean  @default(false)
  T_ID        String   @db.VarChar(10)
  Task        Task     @relation(fields: [T_ID], references: [T_ID], onDelete: Cascade)

  @@index([T_ID], map: "FK_CLI_Task")
}

model Attachment {
  AT_ID      String   @id @default(uuid()) @db.VarChar(36)
  FileName   String   @db.VarChar(255)
  FileUrl    String   @db.Text
  UploadDate DateTime @default(now())
  T_ID       String   @db.VarChar(10)
  Task       Task     @relation(fields: [T_ID], references: [T_ID], onDelete: Cascade)

  @@index([T_ID], map: "FK_ATT_Task")
}

model Task_Report {
  TR_ID                                        String    @id @db.VarChar(10)
  Progress                                     String?   @db.VarChar(50)
  Period_Type                                  String?   @db.VarChar(30)
  Period_Start                                 DateTime? @db.Date
  Period_End                                   DateTime? @db.Date
  Content                                      String?   @db.Text
  Complete_At                                  DateTime? @db.DateTime(0)
  T_ID                                         String    @db.VarChar(10)
  Reporter_A_ID                                String?   @db.VarChar(10)
  Created_By_A_ID                              String?   @db.VarChar(10)
  Status                                       String?   @db.VarChar(30)
  Deleted_At                                   DateTime? @db.DateTime(0)
  Deleted_By                                   String?   @db.VarChar(10)
  IsDeleted                                    Boolean   @default(false)
  Account_Task_Report_Created_By_A_IDToAccount Account?  @relation("Task_Report_Created_By_A_IDToAccount", fields: [Created_By_A_ID], references: [A_ID], onDelete: NoAction, onUpdate: NoAction, map: "FK_TR_CreatedBy")
  Account_Task_Report_Reporter_A_IDToAccount   Account?  @relation("Task_Report_Reporter_A_IDToAccount", fields: [Reporter_A_ID], references: [A_ID], onDelete: NoAction, onUpdate: NoAction, map: "FK_TR_Reporter")
  Task                                         Task      @relation(fields: [T_ID], references: [T_ID], onDelete: NoAction, onUpdate: NoAction, map: "FK_TR_Task")

  @@index([Created_By_A_ID], map: "FK_TR_CreatedBy")
  @@index([Reporter_A_ID], map: "FK_TR_Reporter")
  @@index([T_ID], map: "FK_TR_Task")
}

model Task_Member {
  TM_ID         Int      @id @default(autoincrement())
  T_ID          String   @db.VarChar(10)
  M_ID          String   @db.VarChar(10)
  Role          String?  @default("member") @db.VarChar(50)
  Added_At      DateTime @default(now()) @db.DateTime(0)
  Added_By_A_ID String?  @db.VarChar(10)
  Member        Member   @relation(fields: [M_ID], references: [M_ID], onDelete: Cascade, onUpdate: NoAction, map: "FK_TM_Member")
  Task          Task     @relation(fields: [T_ID], references: [T_ID], onDelete: Cascade, onUpdate: NoAction, map: "FK_TM_Task")

  @@unique([T_ID, M_ID], map: "unique_task_member")
  @@index([T_ID], map: "FK_TM_Task")
}

model TaskComment {
  TC_ID      String   @id @default(uuid()) @db.VarChar(36)
  Content    String   @db.Text
  Created_At DateTime @default(now())
  T_ID       String   @db.VarChar(10)
  A_ID       String   @db.VarChar(10)
  Task       Task     @relation(fields: [T_ID], references: [T_ID], onDelete: Cascade)
  Account    Account  @relation(fields: [A_ID], references: [A_ID], onDelete: Cascade)

  @@index([T_ID], map: "FK_TC_Task")
  @@index([A_ID], map: "FK_TC_Account")
}

model SystemLog {
  LogID       String   @id @default(uuid()) @db.VarChar(36)
  Action      String   @db.VarChar(50)
  Message     String   @db.VarChar(500)
  CreatedAt   DateTime @default(now()) @db.DateTime(0)
  ActorId     String   @db.VarChar(10)
  TargetType  String?  @db.VarChar(50)
  TargetId    String?  @db.VarChar(50)
  
  Actor       Account  @relation(fields: [ActorId], references: [A_ID], onDelete: Cascade)

  @@index([ActorId])
  @@index([Action])
  @@index([CreatedAt])
}
